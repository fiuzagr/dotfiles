#!/usr/bin/env sh

set -e

LOG_FILE=~/.local/var/logs/git-force.log

exec 3>&1 4>&2
trap 'exec 2>&4 1>&3' 0 1 2 3 15
exec 1>"$LOG_FILE" 2>&1

main() {
    branch="$1"

    if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
        echo "Do not use main or master branch" >&3
        exit 1
    fi

    echo "--------------------------------" >&3
    echo "Overwriting the branch: $branch" >&3

    {
        git fetch --all &&
        git branch -D "$branch" &&
        git checkout -b "$branch" &&
        git push -f -u origin "$branch" &&
        git checkout -
    } || {
        echo "An error occurred while managing branch $branch" >&3
        echo "See logs at $LOG_FILE" >&3
        git checkout - 2>/dev/null || true
        exit 1
    }

    echo "Done!" >&3
    echo "--------------------------------" >&3

    return
}
main "$@"

exit 0
