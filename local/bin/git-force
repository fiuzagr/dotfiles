#!/usr/bin/env sh

set -e

LOG_FILE="$HOME/.local/var/logs/git-force.log"

git_cmd() {
  if ! git "$@" >>"$LOG_FILE" 2>&1; then
    echo "Git command failed: git $*"
    echo "Check log file: $LOG_FILE"
    exit 1
  fi
}

main() {
  branch="$1"

  if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
    echo "Do not use main or master branch"
    exit 1
  fi

  echo "--------------------------------"
  echo "Overwriting the branch: $branch"

  {
    git_cmd fetch --all
    { git branch -D "$branch" || true; }
    git_cmd checkout -b "$branch"
    git_cmd push -f -u origin "$branch"
    git_cmd checkout -
  } || {
    echo "An error occurred while managing branch $branch"
    echo "Check log file: $LOG_FILE"
    git checkout - >>"$LOG_FILE" 2>&1 || true
    exit 1
  }

  echo "Done!"
  echo "--------------------------------"

  return
}
main "$@"
